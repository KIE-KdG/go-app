{{define "title"}}Home{{end}}
{{define "main"}}

<body class="bg-gray-100 dark:bg-gray-900">
  <div class="min-h-screen flex items-center mx-auto">
      <div x-data="chatApp()" x-init="init()" class="container">
    <!-- Chat Input Form: now always appears below the chat container -->
    <div class="card bg-base-100 w-5/6 shadow-xl dark:bg-gray-700">
      <div class="p-6">
        <form @submit.prevent="sendMessage" class="relative w-full">
          <!-- Chat input -->
          <textarea id="messageInput" x-model="inputMessage" placeholder="Type your message"
            class="input w-full h-24 rounded focus:outline-none focus:ring-2 dark:bg-gray-700 dark:text-white dark:border-gray-700"></textarea>

          <!-- Overlayed Checkboxes as rounded toggle buttons -->
          <div class="card-actions justify-start">
            <label class="flex min-w-8 h-9"
              :class="{'btn': true, 'btn-primary': dbUsed, 'btn-outline': !dbUsed, 'rounded-full': true}">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="bevel">
                <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
              </svg>
              <input type="checkbox" x-model="dbUsed" class="hidden">
              DB
            </label>
            <label class="flex min-w-8 h-9"
              :class="{'btn': true, 'btn-primary': docsUsed, 'btn-outline': !docsUsed, 'rounded-full': true}">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="bevel">
                <path d="M13 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V9l-7-7z" />
                <path d="M13 3v6h6" />
              </svg>
              <input type="checkbox" x-model="docsUsed" class="hidden">
              Docs
            </label>
            <!-- Submit button with an icon -->
            <button type="submit" id="sendButton"
              class="absolute right-2 bottom-2 bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="bevel">
                <circle cx="12" cy="12" r="10" />
                <path d="M16 12l-4-4-4 4M12 16V9" />
              </svg>
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>
  </div>



  <script>
    function chatApp() {
      return {
        ws: null,
        inputMessage: '',
        messages: [],
        dbUsed: false,
        docsUsed: false,
        init() {
          // Establish a WebSocket connection.
          this.ws = new WebSocket('wss://localhost:4000/ws');
          this.ws.addEventListener('open', () => {
            console.log('WebSocket connection established');
          });
          this.ws.addEventListener('message', (event) => {
            console.log('Received:', event.data);
            let data;
            try {
              data = JSON.parse(event.data);
            } catch (e) {
              data = { prompt: event.data };
            }
            // Append streaming tokens to the latest AI message.
            if (this.messages.length > 0 && this.messages[this.messages.length - 1].sender === 'AI') {
              this.messages[this.messages.length - 1].text += data.prompt;
            } else {
              this.messages.push({
                sender: 'AI',
                text: data.prompt
              });
            }
            // Auto-scroll to the bottom.
            this.$nextTick(() => {
              const chatMessages = document.getElementById('chatMessages');
              if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
              }
            });
          });
          this.ws.addEventListener('close', () => {
            console.log('WebSocket connection closed');
          });
          this.ws.addEventListener('error', (error) => {
            console.error('WebSocket error:', error);
          });
        },
        sendMessage() {
          if (!this.inputMessage.trim()) return;
          // Add user's message to the chat.
          this.messages.push({
            sender: 'You',
            text: this.inputMessage
          });
          // Log the current states for debugging.
          console.log("Sending message with dbUsed:", this.dbUsed, "docsUsed:", this.docsUsed);
          // Send the actual values of the checkboxes along with the prompt.
          if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({
              message: this.inputMessage,
              dbUsed: this.dbUsed,
              docsUsed: this.docsUsed
            }));
          } else {
            console.error('WebSocket is not open');
          }
          // Clear the input field.
          this.inputMessage = '';
        }
      }
    }
  </script>
</body>
{{end}}