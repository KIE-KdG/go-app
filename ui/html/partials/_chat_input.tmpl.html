{{define "chat_input"}}
<div class="card bg-base-100 w-full shadow-xl sticky bottom-0 z-0">
  <div class="p-6 relative">
    <form @submit.prevent="!isProcessing && inputMessage.trim() ? sendMessage() : null" class="relative w-full">
      <div class="relative">
        <textarea id="messageInput" x-model="inputMessage"
          @keydown.enter.prevent="!isProcessing && inputMessage.trim() ? sendMessage() : null"
          placeholder="Type your message" :disabled="isProcessing" x-ref="messageInput" @input="autoResizeTextarea"
          class="input w-full px-3 py-2 resize-none overflow-hidden rounded bg-base-200 dark:bg-base-200 focus:outline-none"
          :class="{'opacity-75': isProcessing}" style="min-height: 60px; max-height: 200px;"></textarea>
      </div>

      <div class="card-actions justify-start mt-2">
        <label class="flex min-w-8 h-9"
          :class="{'btn': true, 'btn-primary': dbUsed, 'btn-outline': !dbUsed, 'rounded-full': true, 'opacity-75 cursor-not-allowed': isProcessing}">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="bevel">
            <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
          </svg>
          <input type="checkbox" x-model="dbUsed" class="hidden" :disabled="isProcessing">
          DB
        </label>
        <label class="flex min-w-8 h-9"
          :class="{'btn': true, 'btn-primary': docsUsed, 'btn-outline': !docsUsed, 'rounded-full': true, 'opacity-75 cursor-not-allowed': isProcessing}">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="bevel">
            <path d="M13 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V9l-7-7z" />
            <path d="M13 3v6h6" />
          </svg>
          <input type="checkbox" x-model="docsUsed" class="hidden" :disabled="isProcessing">
          Docs
        </label>
        
        <!-- Map toggle button (only visible when a map is available) -->
        <button x-show="hasMap" x-cloak 
                type="button"
                @click="openMapOverlay(messages.find(m => m.geoJSON)?.geoJSON)"
                class="btn btn-outline btn-primary rounded-full flex items-center gap-2 h-9">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
          Show Map
        </button>
        
        <!-- Combined submit/interrupt button -->
        <button 
          type="button" 
          id="actionButton" 
          @click="isProcessing ? interruptGeneration() : sendMessage()"
          :disabled="!isProcessing && (!inputMessage.trim())"
          class="absolute right-2 bottom-2 p-2 rounded-full transition-colors duration-200"
          :class="isProcessing ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300 disabled:hover:bg-blue-300'"
          :aria-label="isProcessing ? 'Stop generation' : 'Send message'"
        >
          <!-- Stop icon when processing -->
          <svg x-show="isProcessing" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="9" y1="9" x2="15" y2="15"></line>
            <line x1="15" y1="9" x2="9" y2="15"></line>
          </svg>
          <!-- Send icon when not processing -->
          <svg x-show="!isProcessing" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="bevel">
            <circle cx="12" cy="12" r="10" />
            <path d="M16 12l-4-4-4 4M12 16V9" />
          </svg>
        </button>
      </div>
    </form>
  </div>
</div>
{{end}}