{{define "schema_table_form"}}
<div class="flex flex-col space-y-8 w-full">
    <!-- Header/Title Section -->
    <div class="w-full">
        <h2 class="text-2xl font-bold text-base-content mb-2">Database Search Configuration</h2>
        <p class="text-base-content/70">Configure which database schemas and tables will be available for your AI assistant</p>
    </div>

    <!-- Only show when database connection exists -->
    {{if .ProjectDatabase}}
        <!-- Schema Selection Section -->
        <div class="card bg-base-100 shadow-lg w-full">
            <div class="card-body">
                <h2 class="card-title text-lg font-medium mb-4">1. Add Schemas to Metadata</h2>
                <p class="text-base-content/70 mb-4">Choose schemas from your connected database to add to the metadata table.</p>

                <!-- Form for adding schemas to metadata -->
                <form id="addSchemaForm" action="/schema/create" method="POST">
                    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                    <input type="hidden" name="project_id" value="{{.Project.ID}}">
                    <input type="hidden" name="db_id" value="{{.ProjectDatabase.ID}}">
                    
                    <div class="flex flex-col gap-4">
                        <!-- Schema Selection -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">Available Database Schemas</span>
                                <span class="label-text-alt">Hold Ctrl/Cmd to select multiple schemas</span>
                            </label>
                            
                            {{if .SchemaList}}
                                <div class="border rounded-lg bg-base-200 p-2">
                                    <select id="schemaName" name="schemaName" class="select select-bordered w-full h-40" size="5" multiple>
                                        {{range .SchemaList}}
                                            <option value="{{.}}">{{.}}</option>
                                        {{end}}
                                    </select>
                                </div>
                            {{else}}
                                <div class="alert alert-error mb-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                    </svg>
                                    <span>No schemas found in the connected database. Please check your database connection or connect to a different database.</span>
                                </div>
                            {{end}}
                        </div>

                        <!-- Submit Button -->
                        {{if .SchemaList}}
                        <button type="submit" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            Add Schemas to Metadata
                        </button>
                        {{end}}
                    </div>
                </form>
            </div>
        </div>

        <!-- Metadata Schemas Section -->
        <div class="card bg-base-100 shadow-lg w-full">
            <div class="card-body">
                <h2 class="card-title text-lg font-medium mb-4">2. Select Schema(s) from Metadata</h2>
                <p class="text-base-content/70 mb-4">Choose from schemas already stored in the metadata table to load their tables.</p>

                <div class="flex flex-col gap-4">
                    <!-- Metadata Schema Selection -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">Available Schemas in Metadata</span>
                            <span class="label-text-alt">Hold Ctrl/Cmd to select multiple schemas</span>
                        </label>
                        
                        {{if .RegisteredSchemas}}
                            <div class="border rounded-lg bg-base-200 p-2">
                                <select id="metadataSchemaName" class="select select-bordered w-full h-40" size="5" multiple>
                                    {{range .RegisteredSchemas}}
                                        <option value="{{.ID}}">{{.Name}}</option>
                                    {{end}}
                                </select>
                            </div>
                        {{else}}
                            <div class="alert alert-warning mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                <span>No schemas found in metadata. Please add schemas in step 1 first.</span>
                            </div>
                        {{end}}
                    </div>

                    <!-- Load Tables Button -->
                    {{if .RegisteredSchemas}}
                    <button type="button" id="loadTablesBtn" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M8 6h13"></path>
                            <path d="M8 12h13"></path>
                            <path d="M8 18h13"></path>
                            <path d="M3 6h.01"></path>
                            <path d="M3 12h.01"></path>
                            <path d="M3 18h.01"></path>
                        </svg>
                        Load Tables from Selected Schemas
                    </button>
                    {{end}}
                </div>
            </div>
        </div>

        <!-- Tables Selection Section -->
        <div id="tablesSection" class="card bg-base-100 shadow-lg w-full {{if not .RegisteredSchemas}}hidden{{end}}">
            <div class="card-body">
                <h2 class="card-title text-lg font-medium mb-4">3. Select Tables and Columns</h2>
                <p class="text-base-content/70 mb-4">Choose which tables and columns you want to make available to your AI assistant.</p>

                <!-- Loading indicator -->
                <div id="tablesLoading" class="w-full flex justify-center items-center py-8 hidden">
                    <span class="loading loading-spinner loading-lg text-primary"></span>
                    <p class="ml-3">Loading tables...</p>
                </div>

                <!-- Error message area -->
                <div id="tablesError" class="alert alert-error mb-4 hidden"></div>

                <!-- Form for submitting selected tables and columns -->
                <form id="tablesForm" action="/schema/add/tables" method="POST">
                    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                    <input type="hidden" name="project_id" value="{{.Project.ID}}">
                    <div id="selectedTablesData"></div>

                    <!-- Tables Container Header -->
                    <div class="flex flex-col space-y-4">
                        <!-- Search and Controls -->
                        <div class="flex flex-col md:flex-row gap-4 items-center">
                            <div class="form-control flex-grow">
                                <div class="join w-full">
                                    <div class="join-item flex items-center bg-base-200 px-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                        </svg>
                                    </div>
                                    <input type="text" placeholder="Search tables..." id="table-search" class="join-item input input-bordered w-full"/>
                                </div>
                            </div>
                            
                            <div class="flex gap-2 items-center">
                                <button type="button" id="selectAllTables" class="btn btn-sm btn-outline">Select All</button>
                                <button type="button" id="deselectAllTables" class="btn btn-sm btn-outline">Deselect All</button>
                                <div class="dropdown dropdown-bottom dropdown-end">
                                    <label tabindex="0" class="btn btn-sm btn-outline">Filter</label>
                                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                                        <li><a id="filterBySchemaBtn">By Schema</a></li>
                                        <li><a id="filterAlreadySelectedBtn">Already Selected</a></li>
                                        <li><a id="filterNotSelectedBtn">Not Selected</a></li>
                                        <li><a id="resetFiltersBtn">Reset Filters</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Schema filter chips -->
                        <div id="schema-filter-chips" class="flex flex-wrap gap-2 hidden">
                            <!-- Will be populated by JS -->
                        </div>

                        <!-- Tables list -->
                        <div class="divider my-2"></div>
                        
                        <!-- Empty state -->
                        <div id="no-tables-message" class="py-8 text-center hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 opacity-50">
                                <path d="M18 3a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 1 3-3H3a3 3 0 0 1 3-3 3 3 0 0 0 3-3V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 1-3 3h21a3 3 0 0 1-3 3 3 3 0 0 0-3 3V6a3 3 0 0 0-3-3z"></path>
                            </svg>
                            <p class="text-base-content/70">No tables found. Please select at least one schema first.</p>
                        </div>
                        
                        <!-- Table cards container -->
                        <div class="space-y-4" id="tables-container">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Submit Button for selected tables -->
                    <div id="tableSubmitSection" class="mt-6 {{if not .RegisteredSchemas}}hidden{{end}}">
                        <button type="submit" id="updateDataSource" class="btn btn-primary btn-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            Save Selected Tables
                        </button>
                    </div>
                </form>
            </div>
        </div>
    {{else}}
        <!-- Show placeholder message when no database connection exists -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body text-center py-12">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 opacity-50">
                    <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                </svg>
                <h2 class="text-xl font-bold mb-2">Connect a Database First</h2>
                <p class="text-base-content/70 mb-4">You need to set up a database connection before you can configure schemas and tables.</p>
            </div>
        </div>
    {{end}}
</div>

<!-- Table entry template to be cloned by JavaScript -->
<template id="table-entry-template">
    <div class="table-entry card bg-base-200 hover:shadow-md transition-shadow">
        <div class="card-body p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <input type="checkbox" class="table-checkbox checkbox checkbox-primary" />
                    <div class="flex-1">
                        <h3 class="table-name font-medium text-lg"></h3>
                        <div class="flex items-center gap-2">
                            <span class="badge table-schema-badge"></span>
                            <p class="table-description text-sm text-base-content/70"></p>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-circle toggle-columns-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" 
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
            </div>
            <div class="columns-list mt-3 hidden">
                <div class="divider my-2"></div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium">Columns</span>
                    <div class="space-x-2">
                        <button type="button" class="select-all-columns btn btn-xs btn-outline">Select All</button>
                        <button type="button" class="deselect-all-columns btn btn-xs btn-outline">Deselect All</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 columns-grid">
                    <!-- Column entries will be added here -->
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Column entry template -->
<template id="column-entry-template">
    <div class="column-entry flex items-center space-x-2 p-2 rounded hover:bg-base-300">
        <input type="checkbox" class="column-checkbox checkbox checkbox-sm checkbox-secondary" />
        <div>
            <p class="column-name font-medium"></p>
            <p class="column-type text-xs text-base-content/70"></p>
        </div>
    </div>
</template>

<!-- Schema filter chip template -->
<template id="schema-chip-template">
    <div class="schema-filter-chip badge badge-lg gap-2 cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-4 h-4 stroke-current">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tablesSection = document.getElementById('tablesSection');
    const tablesLoading = document.getElementById('tablesLoading');
    const tablesError = document.getElementById('tablesError');
    const tablesContainer = document.getElementById('tables-container');
    const tableSearch = document.getElementById('table-search');
    const tableSubmitSection = document.getElementById('tableSubmitSection');
    const noTablesMessage = document.getElementById('no-tables-message');
    const schemaFilterChips = document.getElementById('schema-filter-chips');
    const tablesForm = document.getElementById('tablesForm');
    const selectedTablesData = document.getElementById('selectedTablesData');
    
    // Selection controls
    const selectAllTablesBtn = document.getElementById('selectAllTables');
    const deselectAllTablesBtn = document.getElementById('deselectAllTables');
    const filterBySchemaBtn = document.getElementById('filterBySchemaBtn');
    const filterAlreadySelectedBtn = document.getElementById('filterAlreadySelectedBtn');
    const filterNotSelectedBtn = document.getElementById('filterNotSelectedBtn');
    const resetFiltersBtn = document.getElementById('resetFiltersBtn');
    
    // Track already selected tables and schemas (for visual indicators)
    let selectedTables = new Set();
    let availableSchemas = new Set();
    let activeSchemaFilters = new Set();
    let allTables = [];
    
    // Initial state - only show schema selection initially
    tablesSection.classList.add('hidden');
    
    // Add Schema Form Submission
    const addSchemaForm = document.getElementById('addSchemaForm');
    if (addSchemaForm) {
        addSchemaForm.addEventListener('submit', function(e) {
            const schemaSelect = document.getElementById('schemaName');
            const selectedSchemas = Array.from(schemaSelect.selectedOptions).map(option => option.value);
            
            if (selectedSchemas.length === 0) {
                e.preventDefault();
                alert('Please select at least one schema');
                return false;
            }
            
            // Form will submit normally to /schema/create and refresh the page
        });
    }
    
    // Load tables button handler
    const loadTablesBtn = document.getElementById('loadTablesBtn');
    if (loadTablesBtn) {
        loadTablesBtn.addEventListener('click', function() {
            // Show tables section and loading indicator
            tablesSection.classList.remove('hidden');
            tablesLoading.classList.remove('hidden');
            tablesError.classList.add('hidden');
            tablesContainer.innerHTML = '';
            
            // Get selected schemas from metadata dropdown
            const schemaSelect = document.getElementById('metadataSchemaName');
            const selectedSchemas = Array.from(schemaSelect.selectedOptions).map(option => option.value);
            
            if (selectedSchemas.length === 0) {
                tablesError.textContent = 'Please select at least one schema from metadata';
                tablesError.classList.remove('hidden');
                tablesLoading.classList.add('hidden');
                return;
            }
            
            // Load tables for the selected metadata schemas
            loadTablesForSchemas(selectedSchemas);
        });
    }
    
    // Function to load tables for selected schemas
    async function loadTablesForSchemas(selectedSchemas) {
        try {
            tablesLoading.classList.remove('hidden');
            tableSubmitSection.classList.remove('hidden');
            noTablesMessage.classList.add('hidden');
            tablesContainer.innerHTML = '';
            
            // Get project ID and CSRF token
            const projectId = document.querySelector('input[name="project_id"]').value;
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            
            if (selectedSchemas.length === 0) {
                noTablesMessage.classList.remove('hidden');
                tablesLoading.classList.add('hidden');
                return;
            }
            
            // Clear existing data
            allTables = [];
            availableSchemas.clear();
            
            // Fetch tables for each selected schema
            for (const schemaId of selectedSchemas) {
                try {
                    // Fetch tables for this schema
                    const response = await fetch(`/api/schema/${schemaId}/tables?project_id=${projectId}`, {
                        method: 'GET',
                        headers: {
                            'X-CSRF-Token': csrfToken,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        console.warn(`Error fetching tables for schema ID ${schemaId}: ${response.status}`);
                        continue; // Continue with other schemas
                    }
                    
                    const tableData = await response.json();
                    
                    // Process tables
                    const tables = Array.isArray(tableData) ? tableData : tableData.tables || [];
                    
                    // Get schema name for display (from the select option text)
                    const schemaOption = document.querySelector(`#metadataSchemaName option[value="${schemaId}"]`);
                    const schemaName = schemaOption ? schemaOption.textContent : schemaId;
                    
                    // Add schema name to available list
                    availableSchemas.add(schemaName);
                    
                    // Add schema name to each table
                    const tablesWithSchema = tables.map(table => ({
                        ...table,
                        schema: schemaName,
                        schema_id: schemaId
                    }));
                    
                    // Add to our collection
                    allTables = [...allTables, ...tablesWithSchema];
                    
                } catch (err) {
                    console.error(`Error processing schema ${schemaId}:`, err);
                    // Continue with other schemas
                }
            }
            
            if (allTables.length > 0) {
                // Render tables and update filter chips
                renderTables(allTables);
                updateSchemaFilterChips();
            } else {
                noTablesMessage.classList.remove('hidden');
                noTablesMessage.querySelector('p').textContent = 'No tables found in the selected schemas.';
            }
            
        } catch (error) {
            console.error('Error loading tables:', error);
            tablesError.textContent = error.message || 'An error occurred while loading tables';
            tablesError.classList.remove('hidden');
        } finally {
            tablesLoading.classList.add('hidden');
        }
    }
    
    // Function to render tables
    function renderTables(tables) {
        console.log("Rendering tables:", tables);
        
        // Clear container
        tablesContainer.innerHTML = '';
        selectedTablesData.innerHTML = ''; // Clear any previous hidden fields
        
        if (!tables || tables.length === 0) {
            noTablesMessage.classList.remove('hidden');
            return;
        }
        
        noTablesMessage.classList.add('hidden');
        
        // Get templates
        const tableTemplate = document.getElementById('table-entry-template');
        const columnTemplate = document.getElementById('column-entry-template');
        
        if (!tableTemplate || !columnTemplate) {
            console.error("Table or column template not found");
            tablesError.textContent = 'Error: Template not found';
            tablesError.classList.remove('hidden');
            return;
        }
        
        // Create table entries
        tables.forEach(table => {
            try {
                if (!table || typeof table !== 'object') {
                    console.warn("Invalid table data:", table);
                    return;
                }
                
                const tableEntry = document.importNode(tableTemplate.content, true).querySelector('.table-entry');
                
                // Set table data - handle missing properties safely
                const tableName = table.table_name || table.tableName || 'Unknown';
                const schemaName = table.schema || table.schemaName || 'Unknown';
                const schemaId = table.schema_id || '';
                const tableId = table.table_id || table.tableId || '';
                const description = table.description || table.tableDescription || 'No description available';
                
                tableEntry.querySelector('.table-name').textContent = tableName;
                tableEntry.querySelector('.table-schema-badge').textContent = schemaName;
                tableEntry.querySelector('.table-description').textContent = description;
                
                // Set data attributes for filtering
                tableEntry.dataset.tableName = tableName.toLowerCase();
                tableEntry.dataset.schemaName = schemaName.toLowerCase();
                tableEntry.dataset.tableId = tableId;
                tableEntry.dataset.schemaId = schemaId;
                
                // Check if this table is already selected
                const isSelected = selectedTables.has(tableId);
                if (isSelected) {
                    tableEntry.classList.add('bg-primary/10', 'border', 'border-primary');
                    tableEntry.querySelector('.table-checkbox').checked = true;
                }
                
                // Add columns if available
                const columnsGrid = tableEntry.querySelector('.columns-grid');
                if (table.columns && Array.isArray(table.columns) && table.columns.length > 0) {
                    table.columns.forEach(column => {
                        if (!column) return;
                        
                        const columnEntry = document.importNode(columnTemplate.content, true).querySelector('.column-entry');
                        
                        // Set column data
                        const columnName = column.column_name || column.columnName || 'Unknown';
                        const columnType = column.column_datatype || column.columnDatatype || column.dataType || 'Unknown';
                        const columnId = column.column_id || column.columnId || '';
                        
                        columnEntry.querySelector('.column-name').textContent = columnName;
                        columnEntry.querySelector('.column-type').textContent = columnType;
                        
                        // Set data attributes
                        const checkbox = columnEntry.querySelector('.column-checkbox');
                        checkbox.dataset.columnId = columnId;
                        checkbox.dataset.columnName = columnName;
                        checkbox.dataset.tableId = tableId;
                        
                        // Check if this column is already selected
                        if (isSelected) {
                            checkbox.checked = true;
                        }
                        
                        columnsGrid.appendChild(columnEntry);
                    });
                } else {
                    columnsGrid.innerHTML = '<p class="col-span-2 text-center py-2">No columns information available</p>';
                }
                
                // Add toggle functionality for columns
                const toggleBtn = tableEntry.querySelector('.toggle-columns-btn');
                const columnsList = tableEntry.querySelector('.columns-list');
                
                toggleBtn.addEventListener('click', function() {
                    columnsList.classList.toggle('hidden');
                    
                    // Toggle icon direction
                    const svg = toggleBtn.querySelector('svg');
                    if (columnsList.classList.contains('hidden')) {
                        svg.innerHTML = '<polyline points="6 9 12 15 18 9"></polyline>';
                    } else {
                        svg.innerHTML = '<polyline points="18 15 12 9 6 15"></polyline>';
                    }
                });
                
                // Add checkbox behavior for table selection
                const tableCheckbox = tableEntry.querySelector('.table-checkbox');
                tableCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedTables.add(tableId);
                        tableEntry.classList.add('bg-primary/10', 'border', 'border-primary');
                        
                        // Select all columns
                        const columnCheckboxes = tableEntry.querySelectorAll('.column-checkbox');
                        columnCheckboxes.forEach(checkbox => {
                            checkbox.checked = true;
                        });
                    } else {
                        selectedTables.delete(tableId);
                        tableEntry.classList.remove('bg-primary/10', 'border', 'border-primary');
                        
                        // Deselect all columns
                        const columnCheckboxes = tableEntry.querySelectorAll('.column-checkbox');
                        columnCheckboxes.forEach(checkbox => {
                            checkbox.checked = false;
                        });
                    }
                    
                    // Update hidden input fields for form submission
                    updateFormFields();
                });
                
                // Add select/deselect all columns functionality
                const selectAllColumnsBtn = tableEntry.querySelector('.select-all-columns');
                const deselectAllColumnsBtn = tableEntry.querySelector('.deselect-all-columns');
                
                selectAllColumnsBtn.addEventListener('click', function() {
                    const columnCheckboxes = tableEntry.querySelectorAll('.column-checkbox');
                    columnCheckboxes.forEach(checkbox => {
                        checkbox.checked = true;
                    });
                    
                    // Ensure table is selected too
                    tableCheckbox.checked = true;
                    selectedTables.add(tableId);
                    tableEntry.classList.add('bg-primary/10', 'border', 'border-primary');
                    
                    // Update hidden input fields for form submission
                    updateFormFields();
                });
                
                deselectAllColumnsBtn.addEventListener('click', function() {
                    const columnCheckboxes = tableEntry.querySelectorAll('.column-checkbox');
                    columnCheckboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    
                    // Update hidden input fields for form submission
                    updateFormFields();
                });
                
                // Add to container
                tablesContainer.appendChild(tableEntry);
                
            } catch (e) {
                console.error("Error rendering table:", e, table);
            }
        });
        
        // Initialize search
        initTableSearch();
    }
    
    // Function to update hidden form fields based on selected tables and columns
    function updateFormFields() {
        // Clear existing hidden fields
        selectedTablesData.innerHTML = '';
        
        // Get all selected tables
        const tableEntries = tablesContainer.querySelectorAll('.table-entry');
        let tableCount = 0;
        
        tableEntries.forEach(entry => {
            const tableCheckbox = entry.querySelector('.table-checkbox');
            
            if (tableCheckbox.checked) {
                const tableId = entry.dataset.tableId;
                const schemaName = entry.querySelector('.table-schema-badge').textContent;
                const tableName = entry.querySelector('.table-name').textContent;
                const schemaId = entry.dataset.schemaId;
                
                // Create hidden field for this table
                const tableIdField = document.createElement('input');
                tableIdField.type = 'hidden';
                tableIdField.name = `tables[${tableCount}][table_id]`;
                tableIdField.value = tableId;
                selectedTablesData.appendChild(tableIdField);
                
                const schemaNameField = document.createElement('input');
                schemaNameField.type = 'hidden';
                schemaNameField.name = `tables[${tableCount}][schema_name]`;
                schemaNameField.value = schemaName;
                selectedTablesData.appendChild(schemaNameField);
                
                const tableNameField = document.createElement('input');
                tableNameField.type = 'hidden';
                tableNameField.name = `tables[${tableCount}][table_name]`;
                tableNameField.value = tableName;
                selectedTablesData.appendChild(tableNameField);
                
                const schemaIdField = document.createElement('input');
                schemaIdField.type = 'hidden';
                schemaIdField.name = `tables[${tableCount}][schema_id]`;
                schemaIdField.value = schemaId;
                selectedTablesData.appendChild(schemaIdField);
                
                // Get selected columns
                const columnCheckboxes = entry.querySelectorAll('.column-checkbox:checked');
                let columnCount = 0;
                
                columnCheckboxes.forEach(checkbox => {
                    const columnIdField = document.createElement('input');
                    columnIdField.type = 'hidden';
                    columnIdField.name = `tables[${tableCount}][columns][${columnCount}][column_id]`;
                    columnIdField.value = checkbox.dataset.columnId;
                    selectedTablesData.appendChild(columnIdField);
                    
                    const columnNameField = document.createElement('input');
                    columnNameField.type = 'hidden';
                    columnNameField.name = `tables[${tableCount}][columns][${columnCount}][column_name]`;
                    columnNameField.value = checkbox.dataset.columnName;
                    selectedTablesData.appendChild(columnNameField);
                    
                    columnCount++;
                });
                
                tableCount++;
            }
        });
    }
    
    // Update schema filter chips
    function updateSchemaFilterChips() {
        // Clear existing chips
        schemaFilterChips.innerHTML = '';
        
        if (availableSchemas.size > 0) {
            // Create a chip for each schema
            availableSchemas.forEach(schema => {
                const chipTemplate = document.getElementById('schema-chip-template');
                const chip = document.importNode(chipTemplate.content, true).querySelector('.schema-filter-chip');
                
                chip.textContent = schema;
                chip.dataset.schema = schema;
                
                // If this schema is an active filter, highlight it
                if (activeSchemaFilters.has(schema)) {
                    chip.classList.add('badge-primary');
                } else {
                    chip.classList.add('badge-outline');
                }
                
                // Add click handler to toggle filter
                chip.addEventListener('click', function() {
                    const schema = this.dataset.schema;
                    
                    if (activeSchemaFilters.has(schema)) {
                        activeSchemaFilters.delete(schema);
                        this.classList.remove('badge-primary');
                        this.classList.add('badge-outline');
                    } else {
                        activeSchemaFilters.add(schema);
                        this.classList.remove('badge-outline');
                        this.classList.add('badge-primary');
                    }
                    
                    // Apply filters
                    applyTableFilters();
                });
                
                schemaFilterChips.appendChild(chip);
            });
            
            // Show the chips section
            schemaFilterChips.classList.remove('hidden');
        } else {
            schemaFilterChips.classList.add('hidden');
        }
    }
    
    // Apply all active filters to the table list
    function applyTableFilters() {
        const searchTerm = tableSearch.value.toLowerCase();
        const tableEntries = tablesContainer.querySelectorAll('.table-entry');
        let visibleCount = 0;
        
        tableEntries.forEach(entry => {
            const tableName = entry.dataset.tableName;
            const schemaName = entry.dataset.schemaName;
            const tableId = entry.dataset.tableId;
            const isSelected = selectedTables.has(tableId);
            
            // Apply schema filter
            let matchesSchemaFilter = true;
            if (activeSchemaFilters.size > 0) {
                matchesSchemaFilter = activeSchemaFilters.has(schemaName);
            }
            
            // Apply selection filter
            let matchesSelectionFilter = true;
            if (document.getElementById('filterAlreadySelectedBtn').classList.contains('active')) {
                matchesSelectionFilter = isSelected;
            } else if (document.getElementById('filterNotSelectedBtn').classList.contains('active')) {
                matchesSelectionFilter = !isSelected;
            }
            
            // Apply search filter
            const matchesSearch = tableName.includes(searchTerm) || 
                                 schemaName.includes(searchTerm);
            
            // Show entry if it matches all filters
            if (matchesSchemaFilter && matchesSelectionFilter && matchesSearch) {
                entry.style.display = 'block';
                visibleCount++;
            } else {
                entry.style.display = 'none';
            }
        });
        
        // Show/hide no results message
        if (visibleCount === 0) {
            noTablesMessage.classList.remove('hidden');
            noTablesMessage.querySelector('p').textContent = 'No tables match your filters.';
        } else {
            noTablesMessage.classList.add('hidden');
        }
    }
    
    // Table search functionality
    function initTableSearch() {
        if (tableSearch) {
            tableSearch.addEventListener('input', function() {
                applyTableFilters();
            });
        }
    }
    
    // Set up select all/none buttons
    if (selectAllTablesBtn) {
        selectAllTablesBtn.addEventListener('click', function() {
            const tableEntries = tablesContainer.querySelectorAll('.table-entry');
            tableEntries.forEach(entry => {
                if (entry.style.display !== 'none') { // Only select visible tables
                    const checkbox = entry.querySelector('.table-checkbox');
                    checkbox.checked = true;
                    
                    // Trigger change event
                    const event = new Event('change');
                    checkbox.dispatchEvent(event);
                }
            });
        });
    }
    
    if (deselectAllTablesBtn) {
        deselectAllTablesBtn.addEventListener('click', function() {
            const tableEntries = tablesContainer.querySelectorAll('.table-entry');
            tableEntries.forEach(entry => {
                if (entry.style.display !== 'none') { // Only deselect visible tables
                    const checkbox = entry.querySelector('.table-checkbox');
                    checkbox.checked = false;
                    
                    // Trigger change event
                    const event = new Event('change');
                    checkbox.dispatchEvent(event);
                }
            });
        });
    }
    
    // Set up filter buttons
    if (filterBySchemaBtn) {
        filterBySchemaBtn.addEventListener('click', function() {
            // Show schema filter chips
            schemaFilterChips.classList.remove('hidden');
        });
    }
    
    if (filterAlreadySelectedBtn) {
        filterAlreadySelectedBtn.addEventListener('click', function() {
            // Toggle active state
            this.classList.toggle('active');
            if (this.classList.contains('active')) {
                // Deactivate the "not selected" filter
                filterNotSelectedBtn.classList.remove('active');
            }
            
            // Apply filters
            applyTableFilters();
        });
    }
    
    if (filterNotSelectedBtn) {
        filterNotSelectedBtn.addEventListener('click', function() {
            // Toggle active state
            this.classList.toggle('active');
            if (this.classList.contains('active')) {
                // Deactivate the "already selected" filter
                filterAlreadySelectedBtn.classList.remove('active');
            }
            
            // Apply filters
            applyTableFilters();
        });
    }
    
    if (resetFiltersBtn) {
        resetFiltersBtn.addEventListener('click', function() {
            // Clear search
            tableSearch.value = '';
            
            // Clear schema filters
            activeSchemaFilters.clear();
            updateSchemaFilterChips();
            
            // Clear selection filters
            filterAlreadySelectedBtn.classList.remove('active');
            filterNotSelectedBtn.classList.remove('active');
            
            // Reset display
            applyTableFilters();
        });
    }
    
    // Handle form submission - convert form data to JSON
    if (tablesForm) {
        tablesForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Stop normal form submission
            
            // Update form fields one final time
            updateFormFields();
            
            // Check if any tables are selected
            const tableInputs = selectedTablesData.querySelectorAll('input[name$="[table_id]"]');
            if (tableInputs.length === 0) {
                tablesError.textContent = 'Please select at least one table and column';
                tablesError.classList.remove('hidden');
                tablesError.scrollIntoView({ behavior: 'smooth' });
                return false;
            }
            
            // Get project ID and CSRF token
            const projectId = document.querySelector('input[name="project_id"]').value;
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            
            // Show loading indicator
            const submitBtn = document.getElementById('updateDataSource');
            submitBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Saving...';
            submitBtn.disabled = true;
            
            // Collect all selected tables and columns
            const selectedTables = [];
            const tableEntries = tablesContainer.querySelectorAll('.table-entry');
            
            tableEntries.forEach(entry => {
                const tableCheckbox = entry.querySelector('.table-checkbox');
                
                if (tableCheckbox.checked) {
                    const tableId = entry.dataset.tableId;
                    const schemaName = entry.querySelector('.table-schema-badge').textContent;
                    const tableName = entry.querySelector('.table-name').textContent;
                    
                    // Get selected columns
                    const selectedColumns = [];
                    const columnCheckboxes = entry.querySelectorAll('.column-checkbox:checked');
                    
                    columnCheckboxes.forEach(checkbox => {
                        selectedColumns.push({
                            column_id: checkbox.dataset.columnId,
                            column_name: checkbox.dataset.columnName
                        });
                    });
                    
                    // Only add if there are selected columns
                    if (selectedColumns.length > 0) {
                        selectedTables.push({
                            table_id: tableId,
                            schema_name: schemaName,
                            table_name: tableName,
                            columns: selectedColumns
                        });
                    }
                }
            });
            
            // Use fetch with JSON data instead of form submission
            fetch(`/api/projects/${projectId}/selected-tables`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify({
                    project_id: String(projectId),
                    tables: selectedTables
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update data source');
                }
                return response.json();
            })
            .then(data => {
                // Show success message
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success mb-4';
                successAlert.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>Tables saved successfully! Your AI assistant can now access these tables.</span>
                `;
                
                // Insert at the top of the tables section
                tablesSection.querySelector('.card-body').insertBefore(
                    successAlert, 
                    tablesSection.querySelector('.card-body').firstChild
                );
                
                // Scroll to success message
                successAlert.scrollIntoView({ behavior: 'smooth' });
                
                // Automatically remove after 5 seconds
                setTimeout(() => {
                    successAlert.remove();
                }, 5000);
                
                // Reset button
                submitBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save Selected Tables';
                submitBtn.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Show error message
                tablesError.textContent = error.message || 'An error occurred while updating data source';
                tablesError.classList.remove('hidden');
                
                // Scroll to error message
                tablesError.scrollIntoView({ behavior: 'smooth' });
                
                // Reset button
                submitBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save Selected Tables';
                submitBtn.disabled = false;
            });
        });
    }
});
</script>
{{end}}