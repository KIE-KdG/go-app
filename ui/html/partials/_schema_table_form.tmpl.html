{{define "schema_table_form"}}
<div class="flex flex-col space-y-8 w-full">
    <!-- Header/Title Section -->
    <div class="w-full">
        <legend class="text-2xl font-bold text-base-content">Database Search Configuration</legend>
    </div>

    <!-- Schema Selection Section -->
    <div class="card bg-base-100 shadow-lg w-full">
        <div class="card-body">
            <h2 class="card-title text-lg font-medium mb-4">1. Select Schema(s)</h2>

            {{if .ProjectSchemas}}
            {{range .ProjectSchemas}}
            <div class="flex flex-col gap-4">
                <select name="schemas" id="schemas" multiple class="select select-bordered w-full h-40" size="5">
                    <option value="public">public</option>
                    <option value="users">users</option>
                    <option value="products">products</option>
                    <option value="sales">sales</option>
                    <option value="analytics">analytics</option>
                    <option value="{{.Name}}">{{.Name}}</option>
                </select>
                <label class="label">
                    <span class="label-text-alt">Hold Ctrl/Cmd to select multiple schemas</span>
                </label>
            </div>
            {{end}}
            {{else}}
            <div class="bg-base-200 rounded-lg p-6 shadow-md">
                <form action="/schema/create" method="POST" novalidate>
                    <input type='hidden' name='csrf_token' value='{{.CSRFToken}}'>
                    <input type='hidden' name='db_id' value='{{.ProjectDatabase.ID}}'>
                    <input type='hidden' name='project_id' value='{{.Project.ID}}'>

                    {{range .Form.SchemaForm.NonFieldErrors}}
                    <div class='alert alert-error mb-4'>{{.}}</div>
                    {{end}}

                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text">Schema Name</span>
                        </label>
                        <input type='text' name='schemaName' value='{{.Form.SchemaForm.Name}}'
                            class="input input-bordered w-full" placeholder="Schema Name">
                    </div>

                    {{with .Form.SchemaForm.FieldErrors.schemaName}}
                    <label class='label'>
                        <span class='label-text-alt text-error'>{{.}}</span>
                    </label>
                    {{end}}

                    <div class="card-actions justify-center mt-4">
                        <button type='submit' class="btn btn-primary w-full">Create Schema</button>
                    </div>
                </form>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Tables Selection Section -->
    <div class="card bg-base-100 shadow-lg w-full">
        <div class="card-body">
            <h2 class="card-title text-lg font-medium mb-4">2. Select Tables and Columns</h2>

            <div class="mb-6">
                <div class="form-control w-full">
                    <input type="text" placeholder="Search tables..." id="table-search"
                        class="input input-bordered w-full" />
                </div>
            </div>

            <div class="space-y-4" id="tables-container">
                <!-- Table 1 Example -->
                <details class="collapse collapse-arrow bg-base-200 rounded-lg">
                    <summary class="collapse-title text-base font-medium flex items-center">
                        <input type="checkbox" name="tables" value="users" class="checkbox checkbox-primary mr-3" />
                        <span>users</span>
                        <span class="badge badge-outline ml-3">Schema: public</span>
                    </summary>
                    <div class="collapse-content">
                        <p class="text-sm mb-4">User account information including login credentials and account status.
                        </p>

                        <div class="divider text-sm">Select Columns</div>

                        <div class="overflow-x-auto">
                            <table class="table table-compact w-full">
                                <thead>
                                    <tr>
                                        <th class="w-16">Select</th>
                                        <th>Column Name</th>
                                        <th>Type</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="columns[users][]" value="id"
                                                class="checkbox checkbox-sm" checked />
                                        </td>
                                        <td>id</td>
                                        <td>
                                            <span class="badge badge-sm">INTEGER</span>
                                            <span class="badge badge-sm badge-primary">PK</span>
                                        </td>
                                        <td>Unique identifier for each user</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="columns[users][]" value="username"
                                                class="checkbox checkbox-sm" checked />
                                        </td>
                                        <td>username</td>
                                        <td>
                                            <span class="badge badge-sm">VARCHAR(100)</span>
                                        </td>
                                        <td>User's login name, must be unique</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="columns[users][]" value="email"
                                                class="checkbox checkbox-sm" checked />
                                        </td>
                                        <td>email</td>
                                        <td>
                                            <span class="badge badge-sm">VARCHAR(255)</span>
                                        </td>
                                        <td>User's email address, used for notifications</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="columns[users][]" value="created_at"
                                                class="checkbox checkbox-sm" />
                                        </td>
                                        <td>created_at</td>
                                        <td>
                                            <span class="badge badge-sm">TIMESTAMP</span>
                                        </td>
                                        <td>When the user account was created</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="columns[users][]" value="last_login"
                                                class="checkbox checkbox-sm" />
                                        </td>
                                        <td>last_login</td>
                                        <td>
                                            <span class="badge badge-sm">TIMESTAMP</span>
                                        </td>
                                        <td>When the user last logged into the system</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </details>

                <!-- Table 2 Example -->
                <details class="collapse collapse-arrow bg-base-200 rounded-lg">
                    <summary class="collapse-title text-base font-medium flex items-center">
                        <input type="checkbox" name="tables" value="products" class="checkbox checkbox-primary mr-3" />
                        <span>products</span>
                        <span class="badge badge-outline ml-3">Schema: products</span>
                    </summary>
                    <div class="collapse-content">
                        <p class="text-sm mb-4">Product catalog with detailed information about each item including
                            pricing,
                            inventory, and descriptions.</p>

                        <div class="divider text-sm">Select Columns</div>

                        <div class="overflow-x-auto">
                            <table class="table table-compact w-full">
                                <thead>
                                    <tr>
                                        <th class="w-16">Select</th>
                                        <th>Column Name</th>
                                        <th>Type</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="columns[products][]" value="id"
                                                class="checkbox checkbox-sm" checked />
                                        </td>
                                        <td>id</td>
                                        <td>
                                            <span class="badge badge-sm">INTEGER</span>
                                            <span class="badge badge-sm badge-primary">PK</span>
                                        </td>
                                        <td>Unique identifier for each product</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="columns[products][]" value="name"
                                                class="checkbox checkbox-sm" checked />
                                        </td>
                                        <td>name</td>
                                        <td>
                                            <span class="badge badge-sm">VARCHAR(200)</span>
                                        </td>
                                        <td>Product name as displayed to customers</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="columns[products][]" value="description"
                                                class="checkbox checkbox-sm" checked />
                                        </td>
                                        <td>description</td>
                                        <td>
                                            <span class="badge badge-sm">TEXT</span>
                                        </td>
                                        <td>Detailed product description</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="columns[products][]" value="price"
                                                class="checkbox checkbox-sm" checked />
                                        </td>
                                        <td>price</td>
                                        <td>
                                            <span class="badge badge-sm">DECIMAL(10,2)</span>
                                        </td>
                                        <td>Current price of the product</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="columns[products][]" value="category_id"
                                                class="checkbox checkbox-sm" />
                                        </td>
                                        <td>category_id</td>
                                        <td>
                                            <span class="badge badge-sm">INTEGER</span>
                                            <span class="badge badge-sm badge-secondary">FK</span>
                                        </td>
                                        <td>Reference to product category</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </details>

                <!-- Table 3 Example -->
                <details class="collapse collapse-arrow bg-base-200 rounded-lg">
                    <summary class="collapse-title text-base font-medium flex items-center">
                        <input type="checkbox" name="tables" value="orders" class="checkbox checkbox-primary mr-3" />
                        <span>orders</span>
                        <span class="badge badge-outline ml-3">Schema: sales</span>
                    </summary>
                    <div class="collapse-content">
                        <p class="text-sm mb-4">Customer order information including order dates, status, and customer
                            relations.</p>

                        <div class="divider text-sm">Select Columns</div>

                        <div class="overflow-x-auto">
                            <table class="table table-compact w-full">
                                <thead>
                                    <tr>
                                        <th class="w-16">Select</th>
                                        <th>Column Name</th>
                                        <th>Type</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="columns[orders][]" value="id"
                                                class="checkbox checkbox-sm" checked />
                                        </td>
                                        <td>id</td>
                                        <td>
                                            <span class="badge badge-sm">INTEGER</span>
                                            <span class="badge badge-sm badge-primary">PK</span>
                                        </td>
                                        <td>Unique identifier for each order</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="columns[orders][]" value="user_id"
                                                class="checkbox checkbox-sm" checked />
                                        </td>
                                        <td>user_id</td>
                                        <td>
                                            <span class="badge badge-sm">INTEGER</span>
                                            <span class="badge badge-sm badge-secondary">FK</span>
                                        </td>
                                        <td>Reference to user who placed the order</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="columns[orders][]" value="order_date"
                                                class="checkbox checkbox-sm" checked />
                                        </td>
                                        <td>order_date</td>
                                        <td>
                                            <span class="badge badge-sm">TIMESTAMP</span>
                                        </td>
                                        <td>When the order was placed</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="columns[orders][]" value="status"
                                                class="checkbox checkbox-sm" checked />
                                        </td>
                                        <td>status</td>
                                        <td>
                                            <span class="badge badge-sm">VARCHAR(50)</span>
                                        </td>
                                        <td>Current order status (pending, shipped, delivered, etc.)</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="columns[orders][]" value="total_amount"
                                                class="checkbox checkbox-sm" checked />
                                        </td>
                                        <td>total_amount</td>
                                        <td>
                                            <span class="badge badge-sm">DECIMAL(12,2)</span>
                                        </td>
                                        <td>Total amount of the order</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <!-- Submit Button Section -->
    <div class="card-actions justify-end mt-4 mb-8">
        <button type="submit" class="btn btn-primary btn-lg">Update data source</button>
    </div>
</div>

<script>
    // Client-side functionality for searching and filtering
    document.addEventListener('DOMContentLoaded', function () {
        // Table search functionality
        const tableSearch = document.getElementById('table-search');
        const tableDetails = document.querySelectorAll('#tables-container details');

        tableSearch.addEventListener('input', function () {
            const searchText = this.value.toLowerCase();
            tableDetails.forEach(details => {
                const tableName = details.querySelector('summary span:nth-child(2)').textContent.toLowerCase();
                const tableDesc = details.querySelector('.collapse-content p').textContent.toLowerCase();
                const isMatch = tableName.includes(searchText) || tableDesc.includes(searchText);
                details.style.display = isMatch ? '' : 'none';
            });
        });

        // Schema selection change handler
        const schemaSelect = document.getElementById('schemas');
        schemaSelect.addEventListener('change', function () {
            // Get selected schemas
            const selectedSchemas = Array.from(this.selectedOptions)
                .map(option => option.value);

            if (selectedSchemas.length === 0) {
                // Show all tables if no schema is selected
                tableDetails.forEach(details => {
                    details.style.display = '';
                });
                return;
            }

            // Filter tables based on selected schemas
            tableDetails.forEach(details => {
                const schemaName = details.querySelector('.badge').textContent.replace('Schema: ', '');
                details.style.display = selectedSchemas.includes(schemaName) ? '' : 'none';
            });
        });
    });
</script>
{{end}}