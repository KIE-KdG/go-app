{{define "chat"}}
<div class="min-h-screen flex justify-center relative" 
  x-data="chatApp()" 
  x-init="init()">
  
  <!-- Chat messages container (fixed width) -->
  <div class="w-full max-w-3xl flex flex-col flex-shrink-0">
    {{template "chat_messages" .}}
    {{template "chat_input" .}}
  </div>
  
  <!-- Side map panel (positioned absolutely to the right of chat) -->
  <div x-show="hasMap && mapVisible" 
       class="hidden lg:block fixed right-0 top-0 bottom-0 w-[600px] z-10 bg-white dark:bg-gray-800 shadow-xl border-l border-gray-200 dark:border-gray-700 overflow-hidden"
       :class="{'animate-slide-in': hasMap && mapVisible}">
    <div class="h-full flex flex-col">
      <!-- Map header with controls -->
      <div class="bg-base-200 p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <h3 class="text-lg font-bold">Map Visualization</h3>
        <div class="flex space-x-2">
          <!-- Fullscreen button -->
          <button @click="openMapFullscreen(currentMapData)" 
                  class="p-1 rounded hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 3 21 3 21 9"></polyline>
              <polyline points="9 21 3 21 3 15"></polyline>
              <line x1="21" y1="3" x2="14" y2="10"></line>
              <line x1="3" y1="21" x2="10" y2="14"></line>
            </svg>
            <span class="hidden md:inline">Fullscreen</span>
          </button>
          
          <!-- Close button -->
          <button @click="mapVisible = false" class="p-1 rounded hover:bg-gray-300 dark:hover:bg-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Main map container -->
      <div class="flex-1 relative">
        <div id="side-map-container" class="absolute inset-0"></div>
      </div>
      
      <!-- Map controls at bottom -->
      <div class="p-3 border-t border-gray-200 dark:border-gray-700 bg-base-100 flex flex-wrap justify-between items-center">
        <div class="flex items-center space-x-2">
          <label class="text-sm font-medium">Map Style:</label>
          <select @change="changeMapStyle($event.target.value)" 
                  class="select select-sm select-bordered rounded py-0 h-8">
            <option value="osm">OpenStreetMap</option>
            <option value="satellite">Satellite</option>
            <option value="topo">Topographic</option>
          </select>
        </div>
        
        <div class="text-sm">
          <span x-show="getMapFeatureCount(currentMapData)">
            <span x-text="getMapFeatureCount(currentMapData)"></span> features
          </span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Fullscreen map modal -->
  <div x-show="isFullscreenMapOpen" 
       class="fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center"
       x-transition:enter="transition ease-out duration-300"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="transition ease-in duration-200"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0">
    
    <div class="bg-white dark:bg-gray-800 w-full h-full flex flex-col">
      <!-- Modal header -->
      <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <h3 class="text-lg font-bold">Map Visualization (Fullscreen)</h3>
        <button @click="closeFullscreenMap" class="p-1 rounded hover:bg-gray-300 dark:hover:bg-gray-600">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <!-- Modal body with map -->
      <div class="flex-1 relative">
        <div id="fullscreen-map" class="absolute inset-0"></div>
      </div>
      
      <!-- Modal footer with controls -->
      <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex flex-wrap justify-between items-center">
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-2">
            <label class="text-sm font-medium">Map Style:</label>
            <select @change="changeMapStyle($event.target.value, 'fullscreen-map')" 
                    class="select select-sm select-bordered rounded">
              <option value="osm">OpenStreetMap</option>
              <option value="satellite">Satellite</option>
              <option value="topo">Topographic</option>
            </select>
          </div>
          
          <div x-show="getMapFeatureCount(fullscreenMapData)">
            <span class="text-sm">
              <span x-text="getMapFeatureCount(fullscreenMapData)"></span> features
            </span>
          </div>
        </div>
        
        <button @click="closeFullscreenMap" class="btn btn-sm btn-primary">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Scroll to bottom button -->
  <button @click="scrollToBottom()" x-show="showScrollButton"
    class="fixed bottom-24 right-4 bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 shadow-lg z-20"
    aria-label="Scroll to bottom">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="bevel">
      <path d="M12 5v14M5 12l7 7 7-7" />
    </svg>
  </button>
</div>

{{template "scripts" .}}
{{template "styles" .}}
{{end}}