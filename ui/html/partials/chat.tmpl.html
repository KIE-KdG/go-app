{{define "chat"}}
<div class="min-h-screen max-w-3xl mx-auto flex flex-col">
  <div x-data="chatApp()" x-init="init()" class="flex flex-col flex-1">
    <!-- Server-rendered Chat messages container with consistent styling -->

    <!-- Dynamic Chat messages container -->
    <div id="chatMessages" class="flex-1 flex flex-col gap-3 px-4 pt-1 overflow-auto">
      {{range .Messages}}
      <div class="chat-message p-2 rounded shadow-md text-black dark:text-white"
        :class="{'bg-blue-100 dark:bg-blue-900': message.sender === 'You', 'bg-green-100 dark:bg-green-900': message.sender === 'AI'}">
        <pre class="message-text whitespace-pre-wrap text-black dark:text-white">{{.Content}}</pre>
      </div>
      {{end}}
      <template x-for="(message, index) in messages" :key="index">
        <div class="chat-message p-2 rounded shadow-md text-black dark:text-white"
          :class="{'bg-blue-100 dark:bg-blue-900': message.sender === 'You', 'bg-green-100 dark:bg-green-900': message.sender === 'AI'}">
          <div class="sender font-bold" x-html="formatMessage(message.sender)"></div>

          <!-- AI Response Block -->
          <template x-if="message.sender === 'AI' && (message.statusUpdates || message.answer)">
            <div>
              <details class="dropdown open" x-show="message.statusUpdates.length > 0">
                <summary class="cursor-pointer text-blue-600 dark:text-blue-400">Status Updates</summary>
                <div class="dropdown-content p-2 bg-white dark:bg-gray-700">
                  <template x-for="(status, i) in message.statusUpdates" :key="i">
                    <p class="text-black dark:text-white" x-text="status"></p>
                  </template>
                </div>
              </details>
              <template x-if="message.answer">
                <pre class="message-text whitespace-pre-wrap text-black dark:text-white"
                  x-html="formatMessage(message.answer)"></pre>
              </template>
            </div>
          </template>

          <!-- User message -->
          <template x-if="message.sender === 'You'">
            <pre class="message-text whitespace-pre-wrap text-black dark:text-white"
              x-html="formatMessage(message.text)"></pre>
          </template>
        </div>
      </template>
    </div>

    <!-- Chat Input Form -->
    <div class="card bg-base-100 w-full shadow-xl sticky bottom-0 z-10">
      <div class="p-6 relative">
        <form @submit.prevent="sendMessage" class="relative w-full">
          <textarea id="messageInput" x-model="inputMessage" placeholder="Type your message"
            class="input w-full h-24 rounded focus:outline-none focus:ring-2"></textarea>
          <div class="card-actions justify-start mt-2">
            <label class="flex min-w-8 h-9"
              :class="{'btn': true, 'btn-primary': dbUsed, 'btn-outline': !dbUsed, 'rounded-full': true}">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="bevel">
                <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
              </svg>
              <input type="checkbox" x-model="dbUsed" class="hidden">
              DB
            </label>
            <label class="flex min-w-8 h-9"
              :class="{'btn': true, 'btn-primary': docsUsed, 'btn-outline': !docsUsed, 'rounded-full': true}">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="bevel">
                <path d="M13 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V9l-7-7z" />
                <path d="M13 3v6h6" />
              </svg>
              <input type="checkbox" x-model="docsUsed" class="hidden">
              Docs
            </label>
            <button type="submit" id="sendButton"
              class="absolute right-2 bottom-2 bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="bevel">
                <circle cx="12" cy="12" r="10" />
                <path d="M16 12l-4-4-4 4M12 16V9" />
              </svg>
            </button>
          </div>
        </form>
      </div>
      <label for="my-drawer" class="btn btn-primary drawer-button">Open drawer</label>
    </div>
  </div>
</div>

<script>
  function chatApp() {
    return {
      ws: null,
      inputMessage: '',
      messages: [],
      currentResponse: null,
      dbUsed: false,
      docsUsed: false,
      init() {
        const chatID = window.location.pathname.split("/")[2];
        this.ws = new WebSocket(`wss://localhost:4000/ws/${chatID}`);
        this.ws.addEventListener('open', () => {
          console.log('WebSocket connection established');
        });
        this.ws.addEventListener('message', (event) => {
          let data = {};
          try {
            data = JSON.parse(event.data);
          } catch (e) {
            console.error('Error parsing JSON:', event.data);
            return;
          }
          if (data.status) {
            if (this.currentResponse) {
              this.currentResponse.statusUpdates.push(data.status.trim());
            }
          }
          if (data.answer) {
            if (!this.currentResponse) {
              this.messages.push({
                sender: 'AI',
                statusUpdates: [],
                answer: ''
              });
              this.currentResponse = this.messages[this.messages.length - 1];
            }
            this.currentResponse.answer = data.answer;
            this.currentResponse = null;
          }
          this.$nextTick(() => {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }
          });
        });
        this.ws.addEventListener('close', () => {
          console.log('WebSocket connection closed');
        });
        this.ws.addEventListener('error', (error) => {
          console.error('WebSocket error:', error);
        });
      },
      sendMessage() {
        if (!this.inputMessage.trim()) return;
        this.messages.push({
          sender: 'You',
          text: this.inputMessage
        });
        this.messages.push({
          sender: 'AI',
          statusUpdates: [],
          answer: ''
        });
        this.currentResponse = this.messages[this.messages.length - 1];
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
          this.ws.send(JSON.stringify({
            message: this.inputMessage,
            dbUsed: this.dbUsed,
            docsUsed: this.docsUsed
          }));
        } else {
          console.error('WebSocket is not open');
        }
        this.inputMessage = '';
      },
      formatMessage(message) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return message.replace(urlRegex, '<a href="$1" target="_blank" class="text-blue-600 dark:text-blue-400 underline">$1</a>');
      }
    }
  }
</script>
{{end}}