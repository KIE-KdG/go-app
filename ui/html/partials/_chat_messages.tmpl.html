{{define "chat_messages"}}
<div id="chatMessages" class="flex-1 flex flex-col gap-3 px-4 pt-1 overflow-auto" @scroll="checkScroll()">
  {{range .Messages}}
  {{/* Compute background class based on sender type */}}
  {{ $bgClass := "" }}
  {{ if eq .SenderType "You" }}
  {{ $bgClass = "bg-blue-100 dark:bg-blue-900" }}
  {{ else if eq .SenderType "AI" }}
  {{ $bgClass = "bg-green-100 dark:bg-green-900" }}
  {{ end }}
  <div class="chat-message p-2 rounded shadow-md text-black dark:text-white {{$bgClass}}">
    <div class="sender font-bold">
      {{ if eq .SenderType "You" }}You{{ else if eq .SenderType "AI" }}AI{{ end }}
    </div>
    <pre class="message-text whitespace-pre-wrap text-black dark:text-white">{{.Content}}</pre>
  </div>
  {{end}}

  <template x-for="(message, index) in messages" :key="index">
    <div class="chat-message p-2 rounded shadow-md text-black dark:text-white"
      :class="{'bg-blue-100 dark:bg-blue-900': message.sender === 'You', 'bg-green-100 dark:bg-green-900': message.sender=== 'AI'}">
      <div class="sender font-bold" x-html="message.sender"></div>

      <!-- AI Response Block -->
      <template x-if="message.sender === 'AI'">
        <div>
          <!-- Response time display -->
          <div x-show="message.responseTime" class="text-xs text-gray-500 dark:text-gray-400 mb-1">
            Response time: <span x-text="message.responseTime"></span>
          </div>

          <!-- Status updates dropdown (always visible if has updates) -->
          <div x-show="message.statusUpdates && message.statusUpdates.length > 0" class="mb-2">
            <details class="dropdown mb-1" :open="isProcessing && currentResponse === message">
              <summary class="cursor-pointer text-sm rounded px-2 py-1"
                :class="{'bg-blue-100 dark:bg-blue-800': isProcessing && currentResponse === message,
                        'text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900': !(isProcessing && currentResponse === message)}">
                <span x-text="message.statusUpdates[message.statusUpdates.length - 1]"></span>
                <span x-show="message.statusUpdates.length > 1" class="text-xs ml-1">(+<span x-text="message.statusUpdates.length - 1"></span> updates)</span>
              </summary>
              <div class="dropdown-content p-2 bg-white dark:bg-gray-700 rounded shadow w-64 md:w-96 z-10">
                <ul class="text-sm space-y-1 max-h-64 overflow-y-auto">
                  <template x-for="(status, i) in message.statusUpdates" :key="i">
                    <li class="py-1 border-b border-gray-100 dark:border-gray-600 last:border-0"
                        :class="{'font-medium': i === message.statusUpdates.length - 1}">
                      <span x-text="status"></span>
                    </li>
                  </template>
                </ul>
              </div>
            </details>
          </div>

          <!-- Actual response with markdown support -->
          <div x-show="message.answer" class="markdown-content text-black dark:text-white"
            x-html="formatMarkdown(message.answer)"></div>
          
          <!-- Map button - only show if this message has GeoJSON data -->
          <div x-show="message.geoJSON" 
               x-cloak
               class="mt-3 flex items-center gap-2">
            <button 
              @click="openMapOverlay(message.geoJSON)"
              class="btn btn-sm btn-outline btn-primary flex items-center gap-1 rounded-md">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
              <span>View on Map</span>
            </button>
            
            <!-- Feature count badge - show number of features in the GeoJSON data -->
            <span class="badge badge-sm" x-text="getFeatureCount(message.geoJSON) + ' features'"></span>
          </div>
        </div>
      </template>

      <!-- User message -->
      <template x-if="message.sender === 'You'">
        <pre class="message-text whitespace-pre-wrap text-black dark:text-white" x-text="message.text"></pre>
      </template>
    </div>
  </template>
</div>
{{end}}